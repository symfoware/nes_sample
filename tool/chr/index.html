<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <title>SW-CHR</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/picnic">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <!-- ref: https://bugzmanov.github.io/nes_ebook/chapter_6_3.html -->

<style type="text/css">
.canvas-wrapper {
    position: relative;
}
.canvas-wrapper canvas {
    position: absolute;
    top: 0;
    left: 0;
}
</style>
</head>
<body style="min-width: 1590px;">
    <nav>
        <button id="open">ファイルを開く(O)</button>
        <button id="save">保存(S)</button>

        <button id="open_palette">パレットを開く</button>
        <button id="save_palette">パレットを保存</button>

        <button id="prev">＜</button>
        <button id="next">＞</button>
        <input type="file" id="file" style="display: none;"/>
    </nav>
    <main>
        <section class="flex" style="padding: 60px 10px 0">
            <!-- https://qiita.com/Teinishi/items/4b84deadb26f1c450722 -->
            <div class="third">
                <div class="canvas-wrapper" style="padding-left: 20px;height:512px;">
                    <canvas id="editor" width="512" height="512"></canvas>
                    <canvas id="editorLayer" width="512" height="512"></canvas>
                    <canvas id="editorCursor" width="512" height="512"></canvas>
                </div>
                <div>
                    <label for="palette_modal" class="button">パレットを追加</label>
                </div>
                <ol id="pallete_list">
                </ol>
                
            </div>
            <div class="two-third">
                <div class="canvas-wrapper">
                    <canvas id="preview" width="1024" height="1024"></canvas>
                    <canvas id="previewLayer" width="1024" height="1024"></canvas>
                </div>
            </div>
        </section>
        <div>

        </div>
    </main>
    <div class="modal">
        <input id="palette_modal" type="checkbox" />
        <label for="palette_modal" class="overlay"></label>
        <article>
            <header>
                <h3>モーダルのタイトル</h3>
                <label for="palette_modal" class="close">×</label>
            </header>
            <section class="content" style="width: 540px;">
                <div style="display: grid;  grid-template-columns: repeat(16, 30px); column-gap: 2px; row-gap: 2px;" id="pallete">
                </div>
                <div class="flex" style="padding-top: 20px;">
                    <div class="third">
                        <div>1:
                            <select style="width: 80px;" id="p1">
                                <option>00</option><option>01</option><option>02</option><option>03</option>
                                <option>04</option><option>05</option><option>06</option><option>07</option>
                                <option>08</option><option>09</option><option>0a</option><option>0b</option>
                                <option>0c</option><option>0d</option><option>0e</option><option>0f</option>
                                <option>00</option><option>11</option><option>12</option><option>13</option>
                                <option>14</option><option>15</option><option>16</option><option>17</option>
                                <option>18</option><option>19</option><option>1a</option><option>1b</option>
                                <option>1c</option><option>1d</option><option>1e</option><option>1f</option>
                                <option>20</option><option>21</option><option>22</option><option>23</option>
                                <option>24</option><option>25</option><option>26</option><option>27</option>
                                <option>28</option><option>29</option><option>2a</option><option>2b</option>
                                <option>2c</option><option>2d</option><option>2e</option><option>2f</option>
                                <option>30</option><option>31</option><option>32</option><option>33</option>
                                <option>34</option><option>35</option><option>36</option><option>37</option>
                                <option>38</option><option>39</option><option>3a</option><option>3b</option>
                                <option>3c</option><option>3d</option><option>3e</option><option>3f</option>
                            </select>
                        </div>
                    </div>
                    <div class="third">
                        <div>2:
                            <select style="width: 80px;" id="p2">
                                <option>00</option><option>01</option><option>02</option><option>03</option>
                                <option>04</option><option>05</option><option>06</option><option>07</option>
                                <option>08</option><option>09</option><option>0a</option><option>0b</option>
                                <option>0c</option><option>0d</option><option>0e</option><option>0f</option>
                                <option>00</option><option>11</option><option>12</option><option>13</option>
                                <option>14</option><option>15</option><option>16</option><option>17</option>
                                <option>18</option><option>19</option><option>1a</option><option>1b</option>
                                <option>1c</option><option>1d</option><option>1e</option><option>1f</option>
                                <option>20</option><option>21</option><option>22</option><option>23</option>
                                <option>24</option><option>25</option><option>26</option><option>27</option>
                                <option>28</option><option>29</option><option>2a</option><option>2b</option>
                                <option>2c</option><option>2d</option><option>2e</option><option>2f</option>
                                <option>30</option><option>31</option><option>32</option><option>33</option>
                                <option>34</option><option>35</option><option>36</option><option>37</option>
                                <option>38</option><option>39</option><option>3a</option><option>3b</option>
                                <option>3c</option><option>3d</option><option>3e</option><option>3f</option>
                            </select>
                        </div>
                    </div>
                    <div class="third">
                        <div>3:
                            <select style="width: 80px;" id="p3">
                                <option>00</option><option>01</option><option>02</option><option>03</option>
                                <option>04</option><option>05</option><option>06</option><option>07</option>
                                <option>08</option><option>09</option><option>0a</option><option>0b</option>
                                <option>0c</option><option>0d</option><option>0e</option><option>0f</option>
                                <option>00</option><option>11</option><option>12</option><option>13</option>
                                <option>14</option><option>15</option><option>16</option><option>17</option>
                                <option>18</option><option>19</option><option>1a</option><option>1b</option>
                                <option>1c</option><option>1d</option><option>1e</option><option>1f</option>
                                <option>20</option><option>21</option><option>22</option><option>23</option>
                                <option>24</option><option>25</option><option>26</option><option>27</option>
                                <option>28</option><option>29</option><option>2a</option><option>2b</option>
                                <option>2c</option><option>2d</option><option>2e</option><option>2f</option>
                                <option>30</option><option>31</option><option>32</option><option>33</option>
                                <option>34</option><option>35</option><option>36</option><option>37</option>
                                <option>38</option><option>39</option><option>3a</option><option>3b</option>
                                <option>3c</option><option>3d</option><option>3e</option><option>3f</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>
            <footer>
                <button id="modal_ok">OK</button>
                <label for="palette_modal" class="button dangerous">
                    キャンセル
                </label>
            </footer>
        </article>
    </div>
<script type="module">
import { CHR, Palette } from './chr.js';
$(() => {

    // 解析クラス初期化
    const chr = new CHR(editor, editorLayer, editorCursor, preview, previewLayer);

    $('#file').on('change', function(event) {
        const reader = new FileReader();
        // 読み込みが完了したら、結果を表示
        reader.onload = function (event) {
            //loadCHR(event.target.result);
            chr.load(event.target.result);
        };
        // ファイルをテキストとして読み込む
        reader.readAsArrayBuffer(event.target.files[0]);
    });

    $('#save').on('click', function() {
        // aタグの生成
        const a = document.createElement('a');
        // レスポンスからBlobオブジェクト＆URLの生成
        const blobUrl = window.URL.createObjectURL(new Blob([chr.toArray()], {
            type: chr.type
        }));
        document.body.appendChild(a);
        a.style = 'display: none';
        // 生成したURLをセット
        a.href = blobUrl;
        // ダウンロードの時にファイル名として表示される
        a.download = 'downlad.chr';
        // クリックイベント発火
        a.click();
    });

    $('#prev').on('click', function() {
        chr.prev();
    });
    $('#next').on('click', function() {
        chr.next();
    });
    $('#open').on('click', function() {
        $('#file').click();
    });
    $('#modal_ok').on('click', function() {
        $('#palette_modal').prop('checked', false);
        const hex1 = $('#p1').val();
        const hex2 = $('#p2').val();
        const hex3 = $('#p3').val();
        const color1 = Palette[parseInt(`0x${hex1}`, 16)];
        const color2 = Palette[parseInt(`0x${hex2}`, 16)];
        const color3 = Palette[parseInt(`0x${hex3}`, 16)];
        
        $('#pallete_list').append(
        `<li class="flex six" style="border: 1px solid">
            <div class="sixth" style="display: flex; align-items: center;width: 20px;">
                1
            </div>
            <div class="sixth" style="display: flex; align-items: center">
                <div style="width:30px;height:30px;background-color: ${color1};margin-left: 20px;">${hex1}</div>
            </div>
            <div class="sixth" style="display: flex; align-items: center">
                <div style="width:30px;height:30px;background-color: ${color2};margin-left: 20px;">${hex2}</div>
            </div>
            <div class="sixth" style="display: flex; align-items: center">
                <div style="width:30px;height:30px;background-color: ${color3};margin-left: 20px;">${hex3}</div>
            </div>
            <div class="third" style="display: flex; align-items: center">
                <button class="pallete_edit">編集</button>
                <button class="pallete_del" style="margin-left:10px">削除</button>
            </div>
        </li>`);
    });

    $(document).on('click', '.pallete_edit', function() {
        $('#palette_modal').prop('checked', true);
    });
    $(document).on('click', '.pallete_del', function() {
        $(this).closest('li').remove();
    });

    // パレット色追加
    Palette.forEach((color, i) => {
        const hex = ('0'+i.toString(16)).slice(-2);
        const rgb = color.slice(1);
        const total = parseInt(rgb.slice(0, 2), 16) + parseInt(rgb.slice(2, 4), 16) + parseInt(rgb.slice(4, 6), 16);
        let fontColor = 'black';
        if (total < 500) {
            fontColor = 'white';
        }
        $('#pallete').append(
            `<div style="height: 30px;border: 1px solid;text-align: center;border-color: black; background-color: ${color}; color:${fontColor}">${hex}</div>`
        );
        
    });

    // キーボード操作追加
    window.addEventListener('keydown', (event) => {
        if (!event.ctrlKey) {
            return;
        }
        switch(event.key) {
            case 'o':
                $('#file').click();
                event.preventDefault();
            break;
            case 's':
                $('#save').click();
                event.preventDefault();
            break;
        }
    });

});
</script>

</body>
</html>