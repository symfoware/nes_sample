.setcpu		"6502"
.autoimport	on

; iNESヘッダ "HEADER"はcfgのSEGMENTSで定義
.segment "HEADER"
	.byte	$4E, $45, $53, $1A	; "NES" Header
	.byte	$02			; PRG-BANKS
	.byte	$01			; CHR-BANKS
	.byte	$01			; Vetrical Mirror
	.byte	$00			; 
	.byte	$00, $00, $00, $00	; 
	.byte	$00, $00, $00, $00	; 

.segment "STARTUP" ;  "STARTUP"はcfgのSEGMENTSで定義
; リセット割り込み
.proc	Reset
	sei
	ldx	#$ff
	txs

; スクリーンオフ
	lda	#$00
	sta	$2000 ; 基本設定をクリア
	sta	$2001 ; マスク設定をクリア

; パレットテーブルへ転送(BG用のみ転送)
; VRAM BG用パレット $3F00～$3F0F へ転送を実施
	lda	#$3f ; VRAMアドレス上位1byte
	sta	$2006
	lda	#$00 ; VRAMアドレス下位1byte
	sta	$2006 ; $2006 へ2回 store を行うことでVRAMのアクセス先番地を設定
	ldx	#$00
	ldy	#$10
copypal:
	lda	palettes, x ; palettes + xの値をaへロード
	sta	$2007 ; VRAMへデータ書き込み実行
	inx ; xインクリメント
	dey ; yデクリメント
	bne	copypal ; yデクリメントの結果0にならなかったらcopypalに戻る


; ネームテーブルへ転送(画面の中央付近)
; VRAM ネームテーブル $2000～$23BF 画面0のBG配置パターン
	jsr drawchip

; パレット指定
	lda #$23
	sta $2006
	lda #$da
	sta $2006
	lda #%01000000
	sta	$2007
	lda #%11100000
	sta	$2007
	lda #%01000000
	sta	$2007
	lda #%11100000
	sta	$2007

; BGのスクリーン表示位置設定左上にぴったり(スクロール設定)
	lda	#$00
	sta	$2005
	sta	$2005

; スクリーンオン
	lda	#$08 ; 00001000 BGのキャラクタテーブル番号を1に
	sta	$2000
	lda	#$1e ; 00011110 スプライト表示,BG表示,左端8x8のスプライト表示,左端8x8のBG表示
	sta	$2001

; 無限ループ
mainloop:
	jmp	mainloop


; 関数定義テスト
drawchip:
	; 間接アドレスのテスト
	; テーブルの上位アドレス
	lda #>map1
	sta v_map_high
	; テーブルの下位アドレス
	lda #<map1
	sta v_map_low
	; map1の書き込み開始位置を設定
	lda	#$20
	sta v_start_high
	lda	#$00
	sta v_start_low
	; map1書き込み実行
	jsr copymap

	; map2テーブルの上位アドレス
	lda #>map2
	sta v_map_high
	; テーブルの下位アドレス
	lda #<map2
	sta v_map_low
	; map2の書き込み開始位置を設定
	lda	#$20
	sta v_start_high
	lda	#$c0
	sta v_start_low
	; map2書き込み実行
	jsr copymap

	; map3テーブルの上位アドレス
	lda #>map3
	sta v_map_high
	; テーブルの下位アドレス
	lda #<map3
	sta v_map_low
	; map3の書き込み開始位置を設定
	lda	#$21
	sta v_start_high
	lda	#$80
	sta v_start_low
	; map3書き込み実行
	jsr copymap

	; map4テーブルの上位アドレス
	lda #>map4
	sta v_map_high
	; テーブルの下位アドレス
	lda #<map4
	sta v_map_low
	; map4の書き込み開始位置を設定
	lda	#$22
	sta v_start_high
	lda	#$40
	sta v_start_low
	; map4書き込み実行
	jsr copymap

	; map5テーブルの上位アドレス
	lda #>map5
	sta v_map_high
	; テーブルの下位アドレス
	lda #<map5
	sta v_map_low
	; map5の書き込み開始位置を設定
	lda	#$23
	sta v_start_high
	lda	#$00
	sta v_start_low
	; map5書き込み実行
	jsr copymap

	rts


copymap:
	ldx #$c0 ; ループ回数
	ldy	#$00 ; yを0

	; 書き込み開始位置をロード
	lda	v_start_high
	sta	$2006
	lda	v_start_low
	sta	$2006

copymaploop:
	; mapの先頭アドレスにyを加えたアドレスの値をロード
	lda	(v_map_low), y
	sta	$2007
	iny
	dex
	bne	copymaploop
	rts

.endproc

; パレットテーブル
palettes:
	.byte	$0f, $20, $1a, $12
	.byte	$0f, $16, $16, $26
	.byte	$0f, $00, $18, $28
	.byte	$0f, $0a, $10, $2a

map1:
	.byte	$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	
map2:
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01

map3:
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01

map4:
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01

map5:
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$00,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01
	.byte	$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$01,$00


; 変数定義方法
.org $0000
v_map_low:	.byte	$00
v_map_high:	.byte	$00
v_start_low:	.byte	$00
v_start_high:	.byte	$00
.segment "VECINFO"
	.word	$0000
	.word	Reset
	.word	$0000

; パターンテーブル
.segment "CHARS"
	.incbin	"downlad.chr"
